generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Auth (NextAuth) ───────────────────────────────────────────────
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core ──────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  MANAGER
  REP
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  emailVerified      DateTime?
  name               String
  passwordHash       String
  image              String?
  role               UserRole  @default(REP)
  managerId          String?
  manager            User?     @relation("ManagerReports", fields: [managerId], references: [id])
  directReports      User[]    @relation("ManagerReports")
  salesforceUserId   String?   @unique
  hibobEmployeeId    String?   @unique
  salary             Decimal?  @db.Decimal(12, 2)
  jobTitle           String?
  department         String?
  startDate          DateTime?
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  accounts           Account[]
  sessions           Session[]
  targets            Target[]
  planAssignments    UserPlanAssignment[]
  commissionEntries  CommissionEntry[]   @relation("CommissionEntryUser")
  createdEntries     CommissionEntry[]   @relation("CommissionEntryCreator")
  bonusEntries       BonusEntry[]        @relation("BonusEntryUser")
  createdBonuses     BonusEntry[]        @relation("BonusEntryCreator")
  ownedPlacements    Placement[]
  ownedTimesheets    Timesheet[]
  teamTargets        TeamTarget[]
  clientTargets      ClientTarget[]
}

// ─── Commission Plans ──────────────────────────────────────────────

model CommissionPlan {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  fiscalYear  String   // e.g. "2026"
  currency    String   @default("GBP")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  components  PlanComponent[]
  assignments UserPlanAssignment[]
}

enum ComponentType {
  // Core placement types
  PLACEMENT_PERM            // % of permanent placement NFI
  PLACEMENT_CONTRACT        // % of contract placement margin/value
  TIMESHEET                 // % of timesheet value

  // Manager override types (% of their team's revenue, excluding their own deals)
  MANAGER_OVERRIDE_PERM     // Manager gets X% of team's perm placements
  MANAGER_OVERRIDE_CONTRACT // Manager gets X% of team's contract placements

  // Account Management types (% per specific client)
  AM_CLIENT_PERM            // AM gets X% on a specific client's perm placements
  AM_CLIENT_CONTRACT        // AM gets X% on a specific client's contract placements

  // Business Development
  BD_ONGOING                // BD gets ongoing X% on timesheets for deals they originated

  // Bonus types
  BONUS_FLAT                // Flat £ amount bonus (e.g. £1000 new client bonus)
  BONUS_NEW_CLIENT          // Flat bonus triggered when a new client is won
  BONUS_QUARTERLY_TARGET    // Bonus paid when quarterly target is hit (e.g. "High Roller")
  BONUS_MILESTONE           // Flat bonus at billing milestones (e.g. £1k at £50k NFI, £5k at £100k)

  // Override/kicker types
  KICKER                    // Higher % kicks in after hitting a threshold
  OVERRIDE                  // Manual override amount (e.g. ad-hoc bonus, clawback correction)
}

model PlanComponent {
  id              String        @id @default(cuid())
  commissionPlanId String
  commissionPlan  CommissionPlan @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  name            String        // e.g. "Permanent Placements", "Mobileye - Contract Placements"
  type            ComponentType
  rate            Decimal?      @db.Decimal(10, 6) // e.g. 0.100000 = 10% (nullable for flat-only components)
  isPercentage    Boolean       @default(true)     // false = flat GBP amount
  minValue        Decimal?      @db.Decimal(12, 2) // tier min
  maxValue        Decimal?      @db.Decimal(12, 2) // tier max
  tier            Int?          // for ordering tiers
  accountFilter   String?       // restrict to specific account name
  kickerThreshold Decimal?      @db.Decimal(12, 2) // KICKER: NFI threshold to activate
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Conditional/trigger fields
  triggerType      String?   // "new_client" | "quarterly_target" | "milestone" | "threshold" | null
  triggerValue     Decimal?  @db.Decimal(12, 2)  // The threshold value that triggers this component
  triggerCondition String?   // "gte" | "gt" | "eq" | null — how to compare against triggerValue
  clientAccountId  String?   // For AM_CLIENT_* types: the specific SFAccount this applies to
  clientAccount    SFAccount? @relation(fields: [clientAccountId], references: [id])
  excludeOwnDeals  Boolean   @default(false)  // For MANAGER_OVERRIDE_*: exclude the manager's own deals
  flatAmount       Decimal?  @db.Decimal(12, 2)  // For BONUS_FLAT, BONUS_NEW_CLIENT etc: the fixed £ amount
  notes            String?   // Free-text description of what this component does

  commissionEntries CommissionEntry[]
  userAssignments   UserPlanAssignment[] @relation("AssignedComponents")
}

model UserPlanAssignment {
  id               String         @id @default(cuid())
  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissionPlanId String
  commissionPlan   CommissionPlan @relation(fields: [commissionPlanId], references: [id], onDelete: Cascade)
  components       PlanComponent[] @relation("AssignedComponents")
  startDate        DateTime
  endDate          DateTime?
  createdAt        DateTime       @default(now())

  @@index([userId, commissionPlanId])
}

// ─── Targets ───────────────────────────────────────────────────────

model Target {
  id                     String   @id @default(cuid())
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  period                 String   // Fiscal quarter format: FY26/27-Q1
  nfiTargetGBP           Decimal  @db.Decimal(12, 2)
  placementTargetCount   Int?
  contractRevenueTarget  Decimal? @db.Decimal(12, 2)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([userId, period])
}

model TeamTarget {
  id              String   @id @default(cuid())
  managerId       String
  manager         User     @relation(fields: [managerId], references: [id], onDelete: Cascade)
  period          String   // Fiscal quarter format: FY26/27-Q1
  nfiTargetGBP    Decimal  @db.Decimal(12, 2)
  placementTarget Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([managerId, period])
}

model ClientTarget {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId    String
  account      SFAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  period       String    // Fiscal quarter format: FY26/27-Q1
  nfiTargetGBP Decimal   @db.Decimal(12, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userId, accountId, period])
}

// ─── Salesforce Synced Data ────────────────────────────────────────

model SFAccount {
  id           String   @id @default(cuid())
  salesforceId String   @unique
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  placements     Placement[]
  timesheets     Timesheet[]
  clientTargets  ClientTarget[]
  planComponents PlanComponent[]
}

enum PlacementType {
  PERM
  CONTRACT
}

model Placement {
  id                    String        @id @default(cuid())
  salesforceId          String        @unique
  name                  String
  accountId             String?
  account               SFAccount?    @relation(fields: [accountId], references: [id])
  candidateContactId    String?
  candidateName         String?
  ownerSalesforceUserId String
  ownerUserId           String?
  owner                 User?         @relation(fields: [ownerUserId], references: [id])
  nfiValue              Decimal       @db.Decimal(12, 2)
  currency              String        @default("GBP")
  placedDate            DateTime?
  invoicedDate          DateTime?
  paidToAkkar           Boolean       @default(false)
  commissionPaid        Boolean       @default(false)
  placementType         PlacementType @default(PERM)
  isClawback            Boolean       @default(false)
  clawbackOfId          String?
  clawbackOf            Placement?    @relation("PlacementClawback", fields: [clawbackOfId], references: [id])
  clawbacks             Placement[]   @relation("PlacementClawback")
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  lastSyncedAt          DateTime?

  timesheets        Timesheet[]
  commissionEntries CommissionEntry[]
}

model Timesheet {
  id                    String     @id @default(cuid())
  salesforceId          String     @unique
  name                  String
  placementId           String?
  placement             Placement? @relation(fields: [placementId], references: [id])
  candidateContactId    String?
  candidateName         String?
  accountId             String?
  account               SFAccount? @relation(fields: [accountId], references: [id])
  ownerSalesforceUserId String
  ownerUserId           String?
  owner                 User?      @relation(fields: [ownerUserId], references: [id])
  weekEnding            DateTime?
  grossValue            Decimal    @db.Decimal(12, 2)
  nfiValue              Decimal    @db.Decimal(12, 2)
  currency              String     @default("GBP")
  approved              Boolean    @default(false)
  paidToAkkar           Boolean    @default(false)
  commissionPaid        Boolean    @default(false)
  isClawback            Boolean    @default(false)
  clawbackOfId          String?
  clawbackOf            Timesheet? @relation("TimesheetClawback", fields: [clawbackOfId], references: [id])
  clawbacks             Timesheet[] @relation("TimesheetClawback")
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  lastSyncedAt          DateTime?

  commissionEntries CommissionEntry[]
}

// ─── Commission Entries ────────────────────────────────────────────

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  HELD
}

enum SourceType {
  PLACEMENT
  TIMESHEET
}

model CommissionEntry {
  id                  String           @id @default(cuid())
  userId              String
  user                User             @relation("CommissionEntryUser", fields: [userId], references: [id])
  planComponentId     String?
  planComponent       PlanComponent?   @relation(fields: [planComponentId], references: [id])
  sourceType          SourceType
  sourcePlacementId   String?
  sourcePlacement     Placement?       @relation(fields: [sourcePlacementId], references: [id])
  sourceTimesheetId   String?
  sourceTimesheet     Timesheet?       @relation(fields: [sourceTimesheetId], references: [id])
  period              String           // YYYY-MM
  grossValue          Decimal          @db.Decimal(12, 2)
  commissionAmount    Decimal          @db.Decimal(12, 2)
  rate                Decimal          @db.Decimal(10, 6)
  isClawback          Boolean          @default(false)
  clawbackOfEntryId   String?
  clawbackOfEntry     CommissionEntry? @relation("EntryClawback", fields: [clawbackOfEntryId], references: [id])
  clawbackEntries     CommissionEntry[] @relation("EntryClawback")
  status              CommissionStatus @default(PENDING)
  isManualOverride    Boolean          @default(false)
  manualOverrideNote  String?
  holdReason          String?
  payoutDate          DateTime?
  backdatedFromPeriod String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  createdByUserId     String?
  createdBy           User?            @relation("CommissionEntryCreator", fields: [createdByUserId], references: [id])

  @@index([userId, period])
  @@index([status])
  @@index([sourcePlacementId])
  @@index([sourceTimesheetId])
}

// ─── Bonus Entries ─────────────────────────────────────────────────

enum BonusType {
  BONUS
  OVERRIDE_BONUS
  DISCRETIONARY
}

model BonusEntry {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation("BonusEntryUser", fields: [userId], references: [id])
  description     String
  amount          Decimal          @db.Decimal(12, 2)
  period          String           // YYYY-MM
  bonusType       BonusType        @default(BONUS)
  status          CommissionStatus @default(PENDING)
  isManualEntry   Boolean          @default(true)
  payoutDate      DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdByUserId String?
  createdBy       User?            @relation("BonusEntryCreator", fields: [createdByUserId], references: [id])

  @@index([userId, period])
}

// ─── Sync Logging ──────────────────────────────────────────────────

enum SyncType {
  SALESFORCE_PLACEMENTS
  SALESFORCE_TIMESHEETS
  SALESFORCE_ACCOUNTS
  HIBOB_SALARIES
}

enum SyncStatus {
  RUNNING
  SUCCESS
  PARTIAL
  FAILED
}

model SyncLog {
  id                String     @id @default(cuid())
  syncType          SyncType
  status            SyncStatus @default(RUNNING)
  recordsProcessed  Int        @default(0)
  recordsCreated    Int        @default(0)
  recordsUpdated    Int        @default(0)
  errorLog          String?    @db.Text
  triggeredBy       String
  startedAt         DateTime   @default(now())
  completedAt       DateTime?
}
